name: Deploy Woolet

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  changes:
    runs-on: namespace-profile-default
    outputs:
      apps: ${{ steps.filter.outputs.apps }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            apps:
              - 'apps/**'
              - 'packages/**'
              - 'bun.lock'
              - 'Dockerfile'
              - '**/Dockerfile'

  test-api:
    needs: changes
    if: needs.changes.outputs.apps == 'true'
    runs-on: namespace-profile-default
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.8

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install 

      - name: Lint and Test API
        run: |
          bun run lint --filter=@woolet/api
          bun run test --filter=@woolet/api

  test-web:
    needs: changes
    if: needs.changes.outputs.apps == 'true'
    runs-on: namespace-profile-default
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.8

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Lint and Test Web
        run: |
          bun run lint --filter=@woolet/web
          bun run test --filter=@woolet/web

  build-and-push:
    needs: [changes, test-api, test-web]
    if: needs.changes.outputs.apps == 'true'
    runs-on: namespace-profile-default
    permissions:
      contents: read
      packages: write
    environment: SSH_PRIVATE_KEY
    strategy:
      fail-fast: false
      matrix:
        component: [api, web, landing]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.component }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.component }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
            VITE_GLITCHTIP_DSN_WEB=${{ secrets.VITE_GLITCHTIP_DSN_WEB }}

  deploy:
    needs: [changes, build-and-push]
    # Run if on main and (apps changed OR we explicitly triggered it OR we are just updating scripts)
    # We use always() and then check results because build-and-push might be skipped
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    runs-on: namespace-profile-default
    environment: SSH_PRIVATE_KEY
    steps:
      - uses: actions/checkout@v4

      - name: Copy Files to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "docker-compose.prod.yml,docker-compose.monitoring.yml,nginx.conf,deploy.sh,.env.example"
          target: "~/woolet"

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          DB_ADMIN_USER: ${{ secrets.DB_ADMIN_USER }}
          DB_ADMIN_PASSWORD: ${{ secrets.DB_ADMIN_PASSWORD }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PORT: ${{ secrets.DB_PORT }}
          GLITCHTIP_DB_PASSWORD: ${{ secrets.GLITCHTIP_DB_PASSWORD }}
          GLITCHTIP_DOMAIN: ${{ secrets.GLITCHTIP_DOMAIN }}
          GLITCHTIP_FROM_EMAIL: ${{ secrets.GLITCHTIP_FROM_EMAIL }}
          GLITCHTIP_SECRET_KEY: ${{ secrets.GLITCHTIP_SECRET_KEY }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.VITE_CLERK_PUBLISHABLE_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          WOOLET_API_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:main
          WOOLET_WEB_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web:main
          WOOLET_LANDING_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/landing:main
          NODE_ENV: ${{ secrets.NODE_ENV }}
          API_URL: ${{ secrets.API_URL }}
          WEB_URL: ${{ secrets.WEB_URL }}
          GLITCHTIP_DSN_API: ${{ secrets.GLITCHTIP_DSN_API }}
          VITE_GLITCHTIP_DSN_WEB: ${{ secrets.VITE_GLITCHTIP_DSN_WEB }}
          VITE_PUBLIC_POSTHOG_KEY: ${{ secrets.VITE_PUBLIC_POSTHOG_KEY }}
          VITE_PUBLIC_POSTHOG_HOST: ${{ secrets.VITE_PUBLIC_POSTHOG_HOST }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
          AI_PROVIDER_ORDER: ${{ secrets.AI_PROVIDER_ORDER }}
          OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}
          OPENROUTER_CHAT_MODEL: ${{ secrets.OPENROUTER_CHAT_MODEL }}
          OPENROUTER_SITE_URL: ${{ secrets.OPENROUTER_SITE_URL }}
          OPENROUTER_APP_NAME: ${{ secrets.OPENROUTER_APP_NAME }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_CHAT_MODEL: ${{ secrets.OPENAI_CHAT_MODEL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
          CURRENCY_API_KEY: ${{ secrets.CURRENCY_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          TWELVE_DATA: ${{ secrets.TWELVE_DATA }}
          VAPID_PUBLIC_KEY: ${{ secrets.VAPID_PUBLIC_KEY }}
          VAPID_PRIVATE_KEY: ${{ secrets.VAPID_PRIVATE_KEY }}
          VAPID_SUBJECT: ${{ secrets.VAPID_SUBJECT }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DB_ADMIN_USER,DB_ADMIN_PASSWORD,DB_USER,DB_PASSWORD,DB_NAME,DB_PORT,GLITCHTIP_DB_PASSWORD,GLITCHTIP_DOMAIN,GLITCHTIP_FROM_EMAIL,GLITCHTIP_SECRET_KEY,REDIS_PASSWORD,CLERK_SECRET_KEY,CLERK_PUBLISHABLE_KEY,VITE_CLERK_PUBLISHABLE_KEY,DATABASE_URL,REDIS_URL,WOOLET_API_IMAGE,WOOLET_WEB_IMAGE,WOOLET_LANDING_IMAGE,NODE_ENV,API_URL,WEB_URL,GLITCHTIP_DSN_API,VITE_GLITCHTIP_DSN_WEB,VITE_PUBLIC_POSTHOG_KEY,VITE_PUBLIC_POSTHOG_HOST,LOG_LEVEL,AI_PROVIDER_ORDER,OPEN_ROUTER_API_KEY,OPENROUTER_CHAT_MODEL,OPENROUTER_SITE_URL,OPENROUTER_APP_NAME,OPENAI_API_KEY,OPENAI_CHAT_MODEL,GEMINI_API_KEY,GEMINI_MODEL,CURRENCY_API_KEY,GROQ_API_KEY,TWELVE_DATA,VAPID_PUBLIC_KEY,VAPID_PRIVATE_KEY,VAPID_SUBJECT
          command_timeout: 20m
          script: |
            cd ~/woolet
            chmod +x deploy.sh
            ./deploy.sh
